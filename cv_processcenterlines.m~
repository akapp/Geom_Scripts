% function cv_processcenterlines(ptdir)

options.ptdir = '/Users/arikappel/GoogleDrive/CRC_Lab/Geometry/Geom_Data/BB061';

[data,varNames] = cv_readindat(options);

[x,y,z,segs,figH,cH] = cv_plotcenterlines(options,data);
cameratoolbar('Show')

key=0;
fprintf('Press any button to continue\r')
while key==0
    key = waitforbuttonpress;
    pause(0.2)
end

if ~isequal([0 90],get(figH.CurrentAxes,'view'))
   warning('set axis to 0 90 for proper function of selectdata3') 
end

fprintf('Select data for further processing\r')
[pind,xs,ys,zs] = selectdata3('selectionmode','lasso','Flip',1);
disp(table(pind,xs,ys,zs,'VariableNames',{'pointslist','xselect','yselect','zselect'}))
% disp({'pointslist','xselect','yselect','zselect'})
% disp([pind,xs,ys,zs])

%% Check selected data and plot
chk = cv_checkxyzselect(x,y,z,pind,xs,ys,zs);

% plot selection
c=reshape([cH.Color]',[3,size(cH,1)])'; %line colors
idx=find(~cellfun(@isempty,xs))';
selFig = figure; hold on
for i=idx
    plot3(xs{i},ys{i},zs{i},'*','color',c(i,:));
end
cameratoolbar('Show')
axis equal
dcm_obj = datacursormode(selFig);
set(dcm_obj,'DisplayStyle','datatip','Enable','on')

% Start point
pause(0.4)
qA = questdlg('Would you like to identify a start point');
if strcmp(qA,'Yes')
    qstate(1)=1;
    key=0;
    fprintf('Choose start point then Press any button to continue\r')
    while key==0
        key = waitforbuttonpress;
        pause(0.2)
    end
    c1 = getCursorInfo(dcm_obj)
else
    qstate(1)=0;
end
try delete(findall(gcf,'Type','hggroup')); end

% End point
pause(0.4)
qA = questdlg('Would you like to identify an End point');
if strcmp(qA,'Yes')
    qstate(2)=1;
    key=0;
    fprintf('Choose start point then Press any button to continue\r')
    while key==0
        key = waitforbuttonpress;
        pause(0.2)
    end
    c2 = getCursorInfo(dcm_obj)
else
    qstate(2)=0;
end
try delete(findall(gcf,'Type','hggroup')); end

% reference selections back to data
iA = inputdlg('Enter segment name');
segname = iA{1};
if isequal(qstate,[1 1])
    [segment] = cv_selectsegment(data,xs,ys,zs,c1,c2,segname);
elseif isequal(qstate,[1 0])
    [segment] = cv_selectsegment(data,xs,ys,zs,c1,[],segname);
elseif isequal(qstate,[0 1])
    [segment] = cv_selectsegment(data,xs,ys,zs,[],c2,segname);
elseif isequal(qstate,[0 0])
    error('No datapoins selected')
end
close(selFig)
